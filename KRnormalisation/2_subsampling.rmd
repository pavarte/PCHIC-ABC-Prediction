---
title: "subsample HiC"
output: HiC subsample
---

```{r}
library(data.table)
library("parallel")
path_to_hic = "raw_hic/"
output_hic = paste0(dirname(path_to_hic),"/",basename(path_to_hic),"_downsampled_KR")
system(paste("mkdir",output_hic))
chromosomes = list.files(path_to_hic)
```



```{r}
clust <- makeCluster(detectCores())
```


```{r}
## subsampled KR observed and KR normalised?
for(chr in chromosomes){
  matrix = fread(paste0(path_to_hic,chr,"/",chr,".KRobserved.gz"))
  print("Matrix loaded")
  print(chr)
  matrix$V3 = round(matrix$V3,3)*1000
  matrix$V3 = parSapply(clust,matrix$V3, function(x) {sum(runif(as.integer(x)) <= as.numeric(349955328/503139282))})  # Count values
  matrix$V3 = matrix$V3/1000
  print("Subsampled")
  system(paste0("mkdir ", file.path(output_hic,chr)))
  print("Dir made")
  fwrite(matrix,file.path(output_hic,chr,paste0(chr,".KRobserved.gz")),sep = '\t',col.names = FALSE)
  print("File saved")
}
